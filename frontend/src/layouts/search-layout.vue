<template>
  <div
    class="app h-dyn-screen min-h-dyn-screen grid grid-rows-[auto,1fr] bg-white"
    :class="[
      isSidebarVisible
        ? 'has-sidebar grid-cols-[1fr_var(--filter-sidebar-width)]'
        : 'grid-cols-1',
    ]"
  >
    <div class="header-el bg-white">
      <VBanners />
      <VHeaderDesktop
        v-if="isDesktopLayout"
        class="h-20 border-b bg-white"
        :class="headerBorder"
      />
      <VHeaderMobile
        v-else
        class="h-20 border-b bg-white"
        :class="headerBorder"
      />
    </div>

    <aside
      v-if="isSidebarVisible"
      class="sidebar end-0 z-10 h-full overflow-y-auto border-s border-dark-charcoal-20 bg-dark-charcoal-06"
    >
      <VSearchGridFilter class="px-10 py-8" />
      <VSafeBrowsing class="border-t border-dark-charcoal-20 px-10 py-8" />
    </aside>

    <div
      id="main-page"
      class="main-page flex h-full w-full min-w-0 flex-col justify-between overflow-y-auto"
    >
      <div
        :id="skipToContentTargetId"
        tabindex="-1"
        class="browse-page flex w-full flex-col px-6 lg:px-10"
      >
        <VErrorSection
          v-if="fetchingError"
          :fetching-error="fetchingError"
          class="w-full py-10"
        />
        <template v-else>
          <slot :is-filter-sidebar-visible="isSidebarVisible" />
          <footer :class="isAllView ? 'mb-6 mt-4 lg:mb-10' : 'mt-4'">
            <VLoadMore v-if="supported" @load-more="handleLoadMore" />
          </footer>
          <VExternalSearchForm
            v-if="!isAllView"
            :search-term="searchTerm"
            :is-supported="supported"
            :has-no-results="false"
          />
          <VScrollButton
            v-show="showScrollButton"
            :is-filter-sidebar-visible="isSidebarVisible"
            data-testid="scroll-button"
          />
        </template>
      </div>
      <VFooter
        mode="content"
        class="border-t border-dark-charcoal-20 bg-white"
      />
    </div>

    <VGlobalAudioSection />
  </div>
</template>
<script lang="ts">
import { computed, defineComponent, onMounted, provide, ref, watch } from "vue"
import { useScroll } from "@vueuse/core"
import { storeToRefs } from "pinia"

import { useUiStore } from "~/stores/ui"
import { useSearchStore } from "~/stores/search"

import { useAsyncSearch } from "~/composables/use-async-search"

import { IsHeaderScrolledKey, IsSidebarVisibleKey } from "~/types/provides"

import { skipToContentTargetId } from "~/constants/window"
import { ALL_MEDIA } from "~/constants/media"

import VBanners from "~/components/VBanner/VBanners.vue"
import VFooter from "~/components/VFooter/VFooter.vue"
import VGlobalAudioSection from "~/components/VGlobalAudioSection/VGlobalAudioSection.vue"
import VSearchGridFilter from "~/components/VFilters/VSearchGridFilter.vue"
import VSafeBrowsing from "~/components/VSafeBrowsing/VSafeBrowsing.vue"
import VHeaderDesktop from "~/components/VHeader/VHeaderDesktop.vue"
import VHeaderMobile from "~/components/VHeader/VHeaderMobile/VHeaderMobile.vue"
import VErrorSection from "~/components/VErrorSection/VErrorSection.vue"
import VScrollButton from "~/components/VScrollButton.vue"
import VLoadMore from "~/components/VLoadMore.vue"
import VExternalSearchForm from "~/components/VExternalSearch/VExternalSearchForm.vue"

/**
 * This is the SearchLayout: the search page that has a sidebar.
 * It has white background.
 */
export default defineComponent({
  name: "SearchLayout",
  components: {
    VExternalSearchForm,
    VLoadMore,
    VScrollButton,
    VErrorSection,
    VSafeBrowsing,
    VBanners,
    VFooter,
    VGlobalAudioSection,
    VSearchGridFilter,
    VHeaderDesktop,
    VHeaderMobile,
  },
  async setup() {
    const headerRef = ref<HTMLElement | null>(null)
    const mainPageRef = ref<HTMLElement | null>(null)

    const uiStore = useUiStore()
    const searchStore = useSearchStore()

    const { searchTerm, searchTypeIsSupported: supported } =
      storeToRefs(searchStore)

    const isDesktopLayout = computed(() => uiStore.isDesktopLayout)

    /**
     * Filters sidebar is visible only on desktop layouts
     * on search result pages for supported search types.
     */
    const isSidebarVisible = computed(
      () => supported.value && uiStore.isFilterVisible && isDesktopLayout.value
    )

    const isHeaderScrolled = ref(false)
    const showScrollButton = ref(false)

    /**
     * Update the `isHeaderScrolled` and `showScrollButton` values on `main-page` scroll.
     *
     * Note: template refs do not work in a Nuxt layout, so we get the `main-page` element using `document.getElementById`.
     */
    let mainPageElement = ref<HTMLElement | null>(null)

    const { y: mainPageY } = useScroll(mainPageElement)
    watch(mainPageY, (y) => {
      isHeaderScrolled.value = y > 0
      showScrollButton.value = y > 70
    })

    onMounted(() => {
      mainPageElement.value = document.getElementById("main-page")
    })

    provide(IsHeaderScrolledKey, isHeaderScrolled)
    provide(IsSidebarVisibleKey, isSidebarVisible)

    const headerBorder = computed(() =>
      isHeaderScrolled.value || isSidebarVisible.value
        ? "border-b-dark-charcoal-20"
        : "border-b-tx"
    )
    const isAllView = computed(() => searchStore.searchType === ALL_MEDIA)

    const { handleLoadMore, fetchingError } = await useAsyncSearch()

    return {
      mainPageRef,
      headerRef,

      isHeaderScrolled,
      isDesktopLayout,
      isSidebarVisible,

      headerBorder,

      fetchingError,
      handleLoadMore,
      skipToContentTargetId,
      showScrollButton,

      isAllView,
      supported,
      searchTerm,
    }
  },
})
</script>

<style scoped>
.has-sidebar .sidebar {
  width: var(--filter-sidebar-width);
}
.app {
  grid-template-areas: "header" "main";
}
.header-el {
  grid-area: header;
}
.main-page {
  grid-area: main;
}
.sidebar {
  grid-area: sidebar;
}
.has-sidebar.app {
  grid-template-areas: "header header" "main sidebar";
}
</style>
